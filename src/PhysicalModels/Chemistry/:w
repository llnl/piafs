/*! @file ChemistrySolve.c
    @author Debojyoti Ghosh, Albertine Oudin
    @brief Solve the photo-chemical reactions
*/

#include <stdlib.h>
#include <basic.h>
#include <common.h>
#include <arrayfunctions.h>
#include <mpivars.h>
#include <hypar.h>
#include <physicalmodels/chemistry.h>

/*! Write out the reacting species data to file */
int ChemistrySolve(  void*   s,    /*!< Solver object of type #HyPar */
                     void*   p,    /*!< Object of type #Chemistry */
                     void*   m,    /*!< MPI object of type #MPIVariables */
                     double  a_t   /*!< Current simulation time */ )
{
  HyPar        *solver = (HyPar*)        s;
  MPIVariables *mpi    = (MPIVariables*) m;
  Chemistry    *params = (Chemistry*)    p;

  int *dim    = solver->dim_local;
  int ghosts  = solver->ghosts;
  int index[solver->ndims], bounds[solver->ndims], offset[solver->ndims];

  int nz = params->z_i+1;
  int iz;

  int nspecies = params->nspecies;
  for (iz = 0; iz < nz; iz++) {

    /* set bounds for array index to include ghost points */
    _ArrayAddCopy1D_(dim,(2*ghosts),bounds,solver->ndims);
    /* set offset such that index is compatible with ghost point arrangement */
    _ArraySetValue_(offset,solver->ndims,-ghosts);

    int done = 0; _ArraySetValue_(index,solver->ndims,0);
    while (!done) {
      int p; _ArrayIndex1DWO_(solver->ndims,dim,index,offset,ghosts,p);

      double uchem[nspecies+1];
      uchem[0] = params->nv_O2[nz*p+iz];
      uchem[1] = params->nv_O3[nz*p+iz];
      uchem[2] = params->nv_1D[nz*p+iz];
      uchem[3] = params->nv_1Dg[nz*p+iz];
      uchem[4] = params->nv_1Sg[nz*p+iz];
      uchem[5] = params->nv_hnu[nz*p+iz];
      if (iz > 0) {
        uchem[6] = params->nv_O3[nz*p+iz-1];
        uchem[7] = params->nv_hnu[nz*p+iz-1];
      } else {
        uchem[6] = 0.0;
        uchem[7] = 0.0;
      }

      double fchem[nspecies];

      species_arr[nspecies*p+0] = params->nv_O2[nz*p+iz];
      species_arr[nspecies*p+1] = params->nv_O3[nz*p+iz];
      species_arr[nspecies*p+2] = params->nv_1D[nz*p+iz];
      species_arr[nspecies*p+3] = params->nv_1Dg[nz*p+iz];
      species_arr[nspecies*p+4] = params->nv_1Sg[nz*p+iz];
      species_arr[nspecies*p+5] = params->nv_hnu[nz*p+iz];
      _ArrayIncrementIndex_(solver->ndims,bounds,index,done);
    }

  }

  return 0;
}

