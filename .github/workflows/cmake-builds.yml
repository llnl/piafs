name: CMake Builds

on: [push, pull_request]

jobs:
  build:
    name: ${{ matrix.config.name }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        config:
          - name: "Serial (GCC)"
            cmake_options: "-DENABLE_SERIAL=ON"
            deps_script: ""
            run_regression: false

          - name: "MPI (MPICH)"
            cmake_options: ""
            deps_script: ".github/workflows/dependencies/dependencies_mpich.sh"
            run_regression: true

          - name: "MPI (OpenMPI)"
            cmake_options: ""
            deps_script: ".github/workflows/dependencies/dependencies_openmpi.sh"
            run_regression: false

          - name: "MPI + OpenMP (OpenMPI)"
            cmake_options: "-DENABLE_OMP=ON"
            deps_script: ".github/workflows/dependencies/dependencies_openmpi.sh"
            run_regression: false

    steps:
    - uses: actions/checkout@v4

    - name: Install base dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends cmake build-essential g++

    - name: Install MPI dependencies
      if: matrix.config.deps_script != ''
      run: ${{ matrix.config.deps_script }}

    - name: Configure
      run: |
        mkdir build && cd build
        cmake ${{ matrix.config.cmake_options }} -DCMAKE_BUILD_TYPE=Release ..

    - name: Build
      run: cmake --build build -j$(nproc)

    - name: Run unit tests
      run: |
        cd build
        ctest -L unit --output-on-failure -j$(nproc)
      env:
        # Allow OpenMPI to run as root inside GitHub Actions containers
        OMPI_ALLOW_RUN_AS_ROOT: "1"
        OMPI_ALLOW_RUN_AS_ROOT_CONFIRM: "1"
        # Allow oversubscription (up to 4 MPI ranks on 2-vCPU runners)
        OMPI_MCA_rmaps_base_oversubscribe: "1"

    - name: Run regression tests
      if: matrix.config.run_regression
      run: |
        cd build
        ctest -L regression --output-on-failure -j1
      env:
        # Allow OpenMPI to run as root inside GitHub Actions containers
        OMPI_ALLOW_RUN_AS_ROOT: "1"
        OMPI_ALLOW_RUN_AS_ROOT_CONFIRM: "1"
        # Allow oversubscription (up to 4 MPI ranks on 2-vCPU runners)
        OMPI_MCA_rmaps_base_oversubscribe: "1"

    - name: Verify executable
      run: |
        ls build/bin/PIAFS*
        echo "${{ matrix.config.name }} build successful"
