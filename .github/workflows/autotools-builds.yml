name: Autotools Builds

on: [push, pull_request]

jobs:

  serial:
    name: Serial (GCC)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends build-essential g++
    - name: Configure
      run: autoreconf -i && CC=gcc CXX=g++ ./configure --enable-serial
    - name: Build
      run: make -j$(nproc)
    - name: Verify executable
      run: |
        make install
        ls bin/PIAFS*
        echo "Serial build successful (regression tests skipped - require MPI)"

  mpich:
    name: MPI (MPICH)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install dependencies
      run: .github/workflows/dependencies/dependencies_mpich.sh
    - name: Configure
      run: autoreconf -i && ./configure
    - name: Build
      run: make -j$(nproc)
    - name: Test
      run: make check
      env:
        # MPICH doesn't need special flags for running as root
        # Tests use mpiexec from the configure step
        VERBOSE: 1
    - name: Verify executable
      run: |
        make install
        ls bin/PIAFS*
        echo "MPICH build successful"

  openmpi:
    name: MPI (OpenMPI)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install dependencies
      run: .github/workflows/dependencies/dependencies_openmpi.sh
    - name: Configure
      run: autoreconf -i && ./configure
    - name: Build
      run: make -j$(nproc)
    - name: Test
      run: make check
      env:
        # Allow OpenMPI to run as root inside GitHub Actions containers
        OMPI_ALLOW_RUN_AS_ROOT: "1"
        OMPI_ALLOW_RUN_AS_ROOT_CONFIRM: "1"
        # Allow oversubscription (up to 4 MPI ranks on 2-vCPU runners)
        OMPI_MCA_rmaps_base_oversubscribe: "1"
        VERBOSE: 1
    - name: Verify executable
      run: |
        make install
        ls bin/PIAFS*
        echo "OpenMPI build successful"

  openmp:
    name: MPI + OpenMP (OpenMPI)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install dependencies
      run: .github/workflows/dependencies/dependencies_openmpi.sh
    - name: Configure
      run: autoreconf -i && ./configure --enable-omp
    - name: Build
      run: make -j$(nproc)
    - name: Test
      run: make check
      env:
        # Allow OpenMPI to run as root inside GitHub Actions containers
        OMPI_ALLOW_RUN_AS_ROOT: "1"
        OMPI_ALLOW_RUN_AS_ROOT_CONFIRM: "1"
        # Allow oversubscription (up to 4 MPI ranks on 2-vCPU runners)
        OMPI_MCA_rmaps_base_oversubscribe: "1"
        VERBOSE: 1
    - name: Verify executable
      run: |
        make install
        ls bin/PIAFS*
        echo "OpenMPI + OpenMP build successful"
